From 463a2ed139f7b3e0e34c42798fce5f075e6e9536 Mon Sep 17 00:00:00 2001
From: Eduardo Gastal <eslgastal@inf.ufrgs.br>
Date: Sat, 25 Oct 2025 06:48:39 -0300
Subject: [PATCH] WIP

---
 poppler/Annot.cc | 10 +++++++---
 poppler/Form.cc  | 17 ++++++++++++++++-
 2 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/poppler/Annot.cc b/poppler/Annot.cc
index cf92bdbd..692b2298 100644
--- a/poppler/Annot.cc
+++ b/poppler/Annot.cc
@@ -68,6 +68,7 @@
 
 #include <config.h>
 
+#include <cstdio>
 #include <cstdlib>
 #include <cmath>
 #include <cassert>
@@ -5213,6 +5214,8 @@ static void setChildDictEntryValue(Dict *parentDict, const char *childDictName,
 bool AnnotAppearanceBuilder::drawSignatureFieldText(const FormFieldSignature *field, const Form *form, const GfxResources *resources, const GooString *_da, const AnnotBorder *border, const AnnotAppearanceCharacs *appearCharacs,
                                                     const PDFRectangle *rect, XRef *xref, Dict *resourcesDict)
 {
+    border = NULL;
+
     const GooString &contents = field->getCustomAppearanceContent();
     if (contents.toStr().empty()) {
         return false;
@@ -5234,7 +5237,7 @@ bool AnnotAppearanceBuilder::drawSignatureFieldText(const FormFieldSignature *fi
     if (leftText.toStr().empty()) {
         drawSignatureFieldText(contents, form, DefaultAppearance(_da), border, rect, xref, resourcesDict, 0, false /* don't center vertically */, false /* don't center horizontally */);
     } else {
-        const double halfWidth = (rect->x2 - rect->x1) / 2;
+        const double thirdWidth = (rect->x2 - rect->x1) / 3;
 
         double borderWidth = 0;
 
@@ -5254,7 +5257,7 @@ bool AnnotAppearanceBuilder::drawSignatureFieldText(const FormFieldSignature *fi
         }
         daLeft.setFontPtSize(leftFontSize);
 
-        PDFRectangle rectLeft(rect->x1, rect->y1, rect->x1 + halfWidth, rect->y2);
+        PDFRectangle rectLeft(rect->x1, rect->y1, rect->x1 + thirdWidth, rect->y2);
         drawSignatureFieldText(leftText, form, daLeft, border, &rectLeft, xref, resourcesDict, 0, true /* center vertically */, true /* center horizontally */);
 
         DefaultAppearance daRight(_da);
@@ -5264,10 +5267,11 @@ bool AnnotAppearanceBuilder::drawSignatureFieldText(const FormFieldSignature *fi
             std::shared_ptr<GfxFont> font = form->getDefaultResources()->lookupFont(daLeft.getFontName().getName());
             fontSize = Annot::calculateFontSize(form, font.get(), &contents, wMax / 2.0, hMax);
         }
+        fontSize *= 1.4;
         daRight.setFontPtSize(fontSize);
 
         PDFRectangle rectRight(rectLeft.x2, rect->y1, rect->x2, rect->y2);
-        drawSignatureFieldText(contents, form, daRight, border, &rectRight, xref, resourcesDict, halfWidth, true /* center vertically */, false /* don't center horizontally */);
+        drawSignatureFieldText(contents, form, daRight, border, &rectRight, xref, resourcesDict, thirdWidth, true /* center vertically */, false /* don't center horizontally */);
     }
 
     return true;
diff --git a/poppler/Form.cc b/poppler/Form.cc
index d39a7785..d9cc8ad8 100644
--- a/poppler/Form.cc
+++ b/poppler/Form.cc
@@ -3172,7 +3172,22 @@ void Form::reset(const std::vector<std::string> &fields, bool excludeFields)
 
 std::string Form::findPdfFontNameToUseForSigning()
 {
-    static constexpr std::array<const char *, 2> fontsToUseToSign = { "Helvetica", "Arial" };
+    static bool first_run = true;
+    if (first_run) {
+        const std::string pdfFontFamily = "DejaVu Sans Small PTBR";
+        const std::string pdfFontStyle  = "";
+        const std::string pdfFontPath   = "@DEJAVU_SANS_PATH@";
+        addFontToDefaultResources(
+            pdfFontPath,
+            0, // face index
+            pdfFontFamily,
+            pdfFontStyle,
+            false // Force plain font name
+            );
+        first_run = false;
+    }
+    /////////////////////
+    static constexpr std::array<const char *, 3> fontsToUseToSign = { "DejaVu Sans Small PTBR", "Helvetica", "Arial" };
     for (const char *fontToUseToSign : fontsToUseToSign) {
         std::string pdfFontName = findFontInDefaultResources(fontToUseToSign, "");
         if (!pdfFontName.empty()) {
-- 
2.44.1

